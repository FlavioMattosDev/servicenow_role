# tasks/modules/api_info/compare_records.yml
---
# Comparar dois registros ou conjuntos de registros

- name: "Validar parâmetros para comparação"
  assert:
    that:
      - api_table is defined
      - api_compare_type is defined
    fail_msg: "api_table e api_compare_type são obrigatórios"

- name: "Obter primeiro conjunto de registros"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ api_table }}"
    query: "{{ api_query_a | default('') }}"
    sysparm_fields: "{{ api_fields | default('sys_id,number,short_description,sys_updated_on') }}"
    sysparm_limit: "{{ api_limit_a | default(50) }}"
    sysparm_order_by: "{{ api_order_by_a | default('sys_updated_on') }}"
  register: api_records_a
  no_log: true
  when: api_compare_type == 'sets'

- name: "Obter segundo conjunto de registros"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ api_table }}"
    query: "{{ api_query_b | default('') }}"
    sysparm_fields: "{{ api_fields | default('sys_id,number,short_description,sys_updated_on') }}"
    sysparm_limit: "{{ api_limit_b | default(50) }}"
    sysparm_order_by: "{{ api_order_by_b | default('sys_updated_on') }}"
  register: api_records_b
  no_log: true
  when: api_compare_type == 'sets'

- name: "Obter registro A (para comparação individual)"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ api_table }}"
    sys_id: "{{ api_sys_id_a }}"
    sysparm_fields: "{{ api_fields | default('*') }}"
    sysparm_display_value: "true"
  register: api_record_a
  no_log: true
  when: api_compare_type == 'single'

- name: "Obter registro B (para comparação individual)"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ api_table }}"
    sys_id: "{{ api_sys_id_b }}"
    sysparm_fields: "{{ api_fields | default('*') }}"
    sysparm_display_value: "true"
  register: api_record_b
  no_log: true
  when: api_compare_type == 'single'

- name: "Comparar conjuntos de registros"
  set_fact:
    api_comparison_result: |
      {% if api_compare_type == 'sets' %}
        {% set set_a_ids = api_records_a.records | map(attribute='sys_id') | list %}
        {% set set_b_ids = api_records_b.records | map(attribute='sys_id') | list %}
        {% set common_ids = set_a_ids | intersect(set_b_ids) %}
        {% set only_in_a = set_a_ids | difference(set_b_ids) %}
        {% set only_in_b = set_b_ids | difference(set_a_ids) %}
        {
          "total_in_a": {{ set_a_ids | length }},
          "total_in_b": {{ set_b_ids | length }},
          "common_count": {{ common_ids | length }},
          "only_in_a_count": {{ only_in_a | length }},
          "only_in_b_count": {{ only_in_b | length }},
          "common_ids": {{ common_ids }},
          "only_in_a_ids": {{ only_in_a }},
          "only_in_b_ids": {{ only_in_b }}
        }
      {% else %}
        {% set diff = {} %}
        {% for key in api_record_a.record.keys() %}
          {% if key in api_record_b.record and api_record_a.record[key] != api_record_b.record[key] %}
            {% set _ = diff.update({key: {"a": api_record_a.record[key], "b": api_record_b.record[key]}}) %}
          {% endif %}
        {% endfor %}
        {
          "fields_different": {{ diff | length }},
          "differences": {{ diff }},
          "record_a_sys_id": "{{ api_record_a.record.sys_id }}",
          "record_b_sys_id": "{{ api_record_b.record.sys_id }}"
        }
      {% endif %}

- name: "Exibir resultado da comparação"
  debug:
    msg: |
      ============================================
      COMPARAÇÃO DE REGISTROS
      ============================================
      Tabela: {{ api_table }}
      Tipo: {{ api_compare_type }}

      {% if api_compare_type == 'sets' %}
      Conjunto A: {{ api_query_a | default('Todos') }} ({{ api_comparison_result.total_in_a }})
      Conjunto B: {{ api_query_b | default('Todos') }} ({{ api_comparison_result.total_in_b }})

      Estatísticas:
      - Registros em comum: {{ api_comparison_result.common_count }}
      - Somente no conjunto A: {{ api_comparison_result.only_in_a_count }}
      - Somente no conjunto B: {{ api_comparison_result.only_in_b_count }}

      {% else %}
      Registro A: {{ api_sys_id_a }}
      Registro B: {{ api_sys_id_b }}

      Diferenças encontradas: {{ api_comparison_result.fields_different }}

      {% if api_comparison_result.fields_different > 0 %}
      Campos diferentes:
        {% for field, values in api_comparison_result.differences.items() %}
      - {{ field }}:
          A: {{ values.a }}
          B: {{ values.b }}
        {% endfor %}
      {% endif %}
      {% endif %}
      ============================================
  changed_when: false
