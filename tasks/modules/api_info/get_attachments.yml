# tasks/modules/api_info/get_attachments.yml
---
# Obter anexos de um registro

- name: "Validar parâmetros para obter anexos"
  assert:
    that:
      - api_table is defined
      - api_sys_id is defined
    fail_msg: "api_table e api_sys_id são obrigatórios"

- name: "Obter Anexos do Registro"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"

    # Usar tabela de anexos
    table: "sys_attachment"
    query: "table_name={{ api_table }}^table_sys_id={{ api_sys_id }}"

    # Campos dos anexos
    sysparm_fields: "sys_id,file_name,content_type,size_bytes,download_link,sys_created_on,sys_created_by"
    sysparm_order_by: "-sys_created_on"
    sysparm_limit: "{{ api_attachment_limit | default(50) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: api_attachments_result
  no_log: true

- name: "Processar informações dos anexos"
  set_fact:
    api_attachments: "{{ api_attachments_result.records }}"
    api_attachment_count: "{{ api_attachments_result.records | length }}"
    api_total_attachment_size: "{{ api_attachments_result.records | sum(attribute='size_bytes') }}"

- name: "Exibir resumo dos anexos"
  debug:
    msg: |
      ============================================
      ANEXOS DO REGISTRO
      ============================================
      Tabela: {{ api_table }}
      SYS_ID: {{ api_sys_id }}
      Total de anexos: {{ api_attachment_count }}
      Tamanho total: {{ api_total_attachment_size | filesizeformat }}

      Tipos de arquivo encontrados:
      {% set mime_types = {} %}
      {% for attachment in api_attachments %}
        {% set mime = attachment.content_type.split('/')[0] %}
        {% if mime_types[mime] is defined %}
          {% set _ = mime_types.update({mime: mime_types[mime] + 1}) %}
        {% else %}
          {% set _ = mime_types.update({mime: 1}) %}
        {% endif %}
      {% endfor %}
      {% for mime, count in mime_types.items() %}
      - {{ mime }}: {{ count }}
      {% endfor %}
      ============================================
  changed_when: false

- name: "Exibir lista de anexos"
  debug:
    msg: |
      Lista de anexos ({{ api_display_limit|default(10) }} primeiros):
      {% for attachment in api_attachments[0:api_display_limit|default(10)] %}
      {{ loop.index }}. {{ attachment.file_name }}
        - Tipo: {{ attachment.content_type }}
        - Tamanho: {{ attachment.size_bytes | filesizeformat }}
        - Criado em: {{ attachment.sys_created_on }}
        - Criado por: {{ attachment.sys_created_by.display_value if attachment.sys_created_by is mapping else attachment.sys_created_by }}
        - Download: {{ attachment.download_link | default('N/A') }}
        - SYS_ID: {{ attachment.sys_id }}
      {% endfor %}
  when: api_attachments | length > 0
  changed_when: false

- name: "Download de anexos específicos (se solicitado)"
  servicenow.itsm.attachment:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    table_sys_id: "{{ api_sys_id }}"
    table_name: "{{ api_table }}"
    sys_id: "{{ item.sys_id }}"
    dest: "{{ api_download_directory | default('/tmp/attachments') }}/{{ item.file_name }}"
  loop: "{{ api_attachments }}"
  when: api_download_attachments | default(false) | bool
  loop_control:
    label: "{{ item.file_name }}"
  register: api_download_result
  no_log: true
