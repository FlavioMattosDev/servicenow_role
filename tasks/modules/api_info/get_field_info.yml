# tasks/modules/api_info/get_field_info.yml
---
# Obter informações detalhadas sobre um campo específico

- name: "Validar parâmetros para obter informações do campo"
  assert:
    that:
      - api_table is defined
      - api_field_name is defined
    fail_msg: "api_table e api_field_name são obrigatórios"

- name: "Obter Informações do Campo"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "sys_dictionary"
    query: "name={{ api_table }}^element={{ api_field_name }}"
    sysparm_fields: "element,sys_name,internal_type,mandatory,max_length,reference,reference_key,column_label,help_tag,default_value,choices,dependent_on_field,dynamic_ref_qual,function_definition,calculation,active,read_only"
    sysparm_limit: 1
  register: api_field_info_result
  no_log: true

- name: "Validar se campo foi encontrado"
  assert:
    that:
      - api_field_info_result.records | length > 0
    fail_msg: "Campo '{{ api_field_name }}' não encontrado na tabela '{{ api_table }}'"

- name: "Processar informações do campo"
  set_fact:
    api_field_info: "{{ api_field_info_result.records[0] }}"

- name: "Obter opções de escolha (se for campo choice)"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "{{ api_field_info.choices }}"
    sysparm_fields: "value,label,sys_id"
    sysparm_order_by: "value"
    sysparm_limit: 100
  register: api_field_choices_result
  no_log: true
  when: api_field_info.choices is defined and api_field_info.choices != ''

- name: "Exibir informações detalhadas do campo"
  debug:
    msg: |
      ============================================
      INFORMAÇÕES DO CAMPO
      ============================================
      Tabela: {{ api_table }}
      Campo: {{ api_field_name }}

      Propriedades básicas:
      - Nome do sistema: {{ api_field_info.sys_name }}
      - Tipo interno: {{ api_field_info.internal_type }}
      - Rótulo: {{ api_field_info.column_label | default('N/A') }}
      - Obrigatório: {{ api_field_info.mandatory | default('false') }}
      - Somente leitura: {{ api_field_info.read_only | default('false') }}
      - Ativo: {{ api_field_info.active | default('true') }}
      - Tamanho máximo: {{ api_field_info.max_length | default('N/A') }}

      Valor padrão: {{ api_field_info.default_value | default('Nenhum') }}
      Ajuda: {{ api_field_info.help_tag | default('N/A') }}

      {% if api_field_info.reference is defined and api_field_info.reference != '' %}
      Referência:
      - Tabela referenciada: {{ api_field_info.reference }}
      - Chave de referência: {{ api_field_info.reference_key | default('sys_id') }}
      {% endif %}

      {% if api_field_info.dependent_on_field is defined %}
      Dependências: {{ api_field_info.dependent_on_field }}
      {% endif %}

      {% if api_field_choices_result is defined and api_field_choices_result.records | length > 0 %}
      Opções disponíveis ({{ api_field_choices_result.records | length }}):
      {% for choice in api_field_choices_result.records %}
      - {{ choice.value }}: {{ choice.label }}
      {% endfor %}
      {% endif %}
      ============================================
  changed_when: false
