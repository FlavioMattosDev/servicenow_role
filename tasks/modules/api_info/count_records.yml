# tasks/modules/api_info/count_records.yml
---
# Contar registros com base em filtros

- name: "Validar parâmetros para contar registros"
  assert:
    that:
      - api_table is defined
    fail_msg: "api_table é obrigatório para contar registros"

- name: "Contar Registros - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"

    # Parâmetros obrigatórios
    table: "{{ api_table }}"

    # Parâmetros de consulta
    query: "{{ api_query | default(omit) }}"
    sysparm_query: "{{ api_sysparm_query | default(omit) }}"

    # Apenas contagem, sem retornar registros
    sysparm_limit: "0"
    sysparm_include_count: "true"

    # Otimização para contagem
    sysparm_exclude_reference_link: "true"
    sysparm_suppress_pagination_header: "true"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: api_count_result
  no_log: true

- name: "Processar resultado da contagem"
  set_fact:
    api_record_count: "{{ api_count_result.total_count | default(0) }}"
    api_query_used: "{{ api_query | default(api_sysparm_query | default('Sem filtro')) }}"

- name: "Exibir resultado da contagem"
  debug:
    msg: |
      ============================================
      CONTAGEM DE REGISTROS
      ============================================
      Tabela: {{ api_table }}
      Filtro aplicado: {{ api_query_used }}
      Total de registros: {{ api_record_count }}

      {% if api_group_by is defined %}
      Agrupamento: {{ api_group_by }}
      {% endif %}

      Timestamp: {{ ansible_date_time.iso8601 }}
      ============================================
  changed_when: false

- name: "Contagem agrupada (se solicitado)"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ api_table }}"
    query: "{{ api_query | default(omit) }}"
    sysparm_group_by: "{{ api_group_by }}"
    sysparm_include_count: "true"
    sysparm_limit: "0"
  register: api_grouped_count_result
  no_log: true
  when: api_group_by is defined

- name: "Exibir contagem agrupada"
  debug:
    msg: |
      Contagem agrupada por {{ api_group_by }}:
      {% if api_grouped_count_result.group_by is defined %}
        {% for group in api_grouped_count_result.group_by %}
      - {{ group.element }}: {{ group.stats.count }}
        {% endfor %}
      {% endif %}
  when: api_group_by is defined and api_grouped_count_result.group_by is defined
  changed_when: false
