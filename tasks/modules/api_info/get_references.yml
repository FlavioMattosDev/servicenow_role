# tasks/modules/api_info/get_references.yml
---
# Obter referências cruzadas de um registro

- name: "Validar parâmetros para obter referências"
  assert:
    that:
      - api_table is defined
      - api_sys_id is defined
    fail_msg: "api_table e api_sys_id são obrigatórios"

- name: "Obter Schema para identificar campos de referência"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "sys_dictionary"
    query: "name={{ api_table }}^reference!=^referenceISNOTEMPTY"
    sysparm_fields: "element,reference"
    sysparm_limit: 50
  register: api_reference_fields
  no_log: true

- name: "Obter Informações do Registro para Extrair Referências"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ api_table }}"
    sys_id: "{{ api_sys_id }}"
    sysparm_display_value: "true"
    sysparm_fields: "{{ api_reference_fields.records | map(attribute='element') | list | join(',') }}"
  register: api_record_references
  no_log: true

- name: "Processar referências diretas"
  set_fact:
    api_direct_references: |
      {% set refs = [] %}
      {% for field in api_reference_fields.records %}
        {% set field_name = field.element %}
        {% set ref_table = field.reference %}
        {% if api_record_references.record[field_name] is defined and api_record_references.record[field_name] is mapping %}
          {% set ref_value = api_record_references.record[field_name].value %}
          {% set ref_display = api_record_references.record[field_name].display_value %}
          {% if ref_value %}
            {% set _ = refs.append({
              'field': field_name,
              'reference_table': ref_table,
              'reference_sys_id': ref_value,
              'reference_display': ref_display
            }) %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {{ refs }}

- name: "Buscar referências reversas (quem referencia este registro)"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "sys_db_object"
    query: "super_class={{ api_table }}^ORname={{ api_table }}"
    sysparm_fields: "name,label"
    sysparm_limit: 20
  register: api_related_tables
  no_log: true

- name: "Buscar registros que referenciam este SYS_ID"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "{{ item.name }}"
    query: "{{ api_table }}={{ api_sys_id }}"
    sysparm_fields: "sys_id,number,short_description"
    sysparm_limit: "{{ api_reverse_limit | default(10) }}"
    sysparm_display_value: "true"
  loop: "{{ api_related_tables.records }}"
  loop_control:
    label: "{{ item.name }}"
  register: api_reverse_references
  no_log: true

- name: "Processar referências reversas"
  set_fact:
    api_all_reverse_refs: |
      {% set all_refs = [] %}
      {% for result in api_reverse_references.results %}
        {% if result.records | length > 0 %}
          {% set _ = all_refs.append({
            'table': result.item.name,
            'label': result.item.label,
            'records': result.records,
            'count': result.records | length
          }) %}
        {% endif %}
      {% endfor %}
      {{ all_refs }}

- name: "Exibir resumo das referências"
  debug:
    msg: |
      ============================================
      REFERÊNCIAS DO REGISTRO
      ============================================
      Tabela: {{ api_table }}
      SYS_ID: {{ api_sys_id }}

      Referências diretas (este registro referencia):
      {% for ref in api_direct_references %}
      - Campo {{ ref.field }} → {{ ref.reference_table }}: {{ ref.reference_display }} ({{ ref.reference_sys_id }})
      {% endfor %}

      Referências reversas (referenciam este registro):
      {% for ref_group in api_all_reverse_refs %}
      - Tabela {{ ref_group.table }} ({{ ref_group.label }}): {{ ref_group.count }} registros
      {% endfor %}
      ============================================
  changed_when: false

- name: "Exibir detalhes das referências reversas"
  debug:
    msg: |
      Detalhes das referências reversas:
      {% for ref_group in api_all_reverse_refs %}
      ============================================
      {{ ref_group.label }} ({{ ref_group.table }}):
      {% for record in ref_group.records[0:api_display_limit|default(5)] %}
      - {{ record.number | default(record.sys_id) }}: {{ record.short_description | default('Sem descrição') }}
      {% endfor %}
      {% if ref_group.records | length > api_display_limit|default(5) %}
        ... e mais {{ ref_group.records | length - api_display_limit|default(5) }} registros
      {% endif %}
      {% endfor %}
  when: api_all_reverse_refs | length > 0
  changed_when: false
