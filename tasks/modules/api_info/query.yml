# tasks/modules/api_info/query.yml
---
# Consultar registros com filtros avançados

- name: "Validar parâmetros para consulta"
  assert:
    that:
      - api_table is defined
    fail_msg: "api_table é obrigatório para consulta"

- name: "Consultar Registros no ServiceNow - CONSULTA AVANÇADA"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"

    # Parâmetros obrigatórios
    table: "{{ api_table }}"

    # Parâmetros de consulta
    query: "{{ api_query | default(omit) }}"
    query_category: "{{ api_query_category | default(omit) }}"
    sysparm_query: "{{ api_sysparm_query | default(omit) }}"
    sysparm_query_no_domain: "{{ api_sysparm_query_no_domain | default(false) }}"

    # Controle de resultados
    sysparm_limit: "{{ api_sysparm_limit | default(100) }}"
    sysparm_offset: "{{ api_sysparm_offset | default(0) }}"
    sysparm_display_value: "{{ api_sysparm_display_value | default('false') }}"
    sysparm_exclude_reference_link: "{{ api_sysparm_exclude_reference_link | default('false') }}"
    sysparm_suppress_pagination_header: "{{ api_sysparm_suppress_pagination_header | default('false') }}"

    # Colunas específicas
    columns: "{{ api_columns | default(omit) }}"
    sysparm_fields: "{{ api_sysparm_fields | default(omit) }}"

    # Ordenação
    sysparm_order_by: "{{ api_sysparm_order_by | default(omit) }}"
    sysparm_order_direction: "{{ api_sysparm_order_direction | default('asc') }}"

    # Controle de cache
    sysparm_view: "{{ api_sysparm_view | default(omit) }}"
    sysparm_group_by: "{{ api_sysparm_group_by | default(omit) }}"

    # Parâmetros de desempenho
    sysparm_read_replica: "{{ api_sysparm_read_replica | default('false') }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: api_query_result
  no_log: true

- name: "Processar resultados da consulta"
  set_fact:
    api_query_results: "{{ api_query_result.records }}"
    api_query_count: "{{ api_query_result.records | length }}"
    api_query_total_count: "{{ api_query_result.total_count | default(api_query_result.records | length) }}"
    api_query_has_more: "{{ api_query_result.has_more | default(false) }}"
  when: api_query_result.records is defined

- name: "Exibir resumo da consulta"
  debug:
    msg: |
      ============================================
      CONSULTA API - RESUMO
      ============================================
      Tabela: {{ api_table }}
      Query: {{ api_query | default('Sem filtro') }}
      Total de registros: {{ api_query_total_count }}
      Registros retornados: {{ api_query_count }}
      Limite: {{ api_sysparm_limit | default(100) }}
      Offset: {{ api_sysparm_offset | default(0) }}
      Tem mais resultados: {{ api_query_has_more }}

      Colunas solicitadas: {{ api_columns | default('Todas') }}
      Ordenação: {{ api_sysparm_order_by | default('Nenhuma') }}
      ============================================
  changed_when: false

- name: "Exibir primeiros resultados (se habilitado)"
  debug:
    var: api_query_results[0:api_display_limit|default(3)]
  when:
    - api_display_results | default(true) | bool
    - api_query_results | length > 0
  changed_when: false

- name: "Salvar resultados em arquivo (se especificado)"
  copy:
    content: "{{ api_query_results | to_nice_json }}"
    dest: "{{ api_output_file }}"
    mode: 0644
  when: api_output_file is defined
  changed_when: false
