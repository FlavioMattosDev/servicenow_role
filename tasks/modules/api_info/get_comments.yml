# tasks/modules/api_info/get_comments.yml
---
# Obter comentários de um registro

- name: "Validar parâmetros para obter comentários"
  assert:
    that:
      - api_table is defined
      - api_sys_id is defined
    fail_msg: "api_table e api_sys_id são obrigatórios"

- name: "Obter Comentários do Registro"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"

    # Usar tabela de journal
    table: "sys_journal_field"
    query: "element_id={{ api_sys_id }}^name=comments^element=comments"
    sysparm_fields: "sys_created_on,sys_created_by,value"
    sysparm_order_by: "-sys_created_on"
    sysparm_limit: "{{ api_comment_limit | default(100) }}"
    sysparm_display_value: "true"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: api_comments_result
  no_log: true

- name: "Processar comentários"
  set_fact:
    api_comments: "{{ api_comments_result.records }}"
    api_comment_count: "{{ api_comments_result.records | length }}"
    api_comment_authors: "{{ api_comments_result.records | map(attribute='sys_created_by.display_value') | unique | list }}"

- name: "Exibir resumo dos comentários"
  debug:
    msg: |
      ============================================
      COMENTÁRIOS DO REGISTRO
      ============================================
      Tabela: {{ api_table }}
      SYS_ID: {{ api_sys_id }}
      Total de comentários: {{ api_comment_count }}
      Autores: {{ api_comment_authors | length }}

      Distribuição temporal:
      {% set years = {} %}
      {% for comment in api_comments %}
        {% set year = comment.sys_created_on[0:4] %}
        {% if years[year] is defined %}
          {% set _ = years.update({year: years[year] + 1}) %}
        {% else %}
          {% set _ = years.update({year: 1}) %}
        {% endif %}
      {% endfor %}
      {% for year, count in years.items() | sort %}
      - {{ year }}: {{ count }} comentários
      {% endfor %}
      ============================================
  changed_when: false

- name: "Exibir comentários recentes"
  debug:
    msg: |
      Comentários mais recentes ({{ api_display_limit|default(5) }}):
      {% for comment in api_comments[0:api_display_limit|default(5)] %}
      --------------------------------------------
      Data: {{ comment.sys_created_on }}
      Autor: {{ comment.sys_created_by.display_value }}

      {{ comment.value }}

      {% endfor %}
  when: api_comments | length > 0
  changed_when: false

- name: "Analisar sentimento dos comentários (simples)"
  set_fact:
    api_comment_analysis: |
      {% set positive_words = ['obrigado', 'thanks', 'resolvido', 'bom', 'excelente', 'ótimo', 'perfeito', 'agradeço'] %}
      {% set negative_words = ['problema', 'erro', 'falha', 'não funciona', 'urgente', 'crítico', 'insatisfeito'] %}
      {% set positive_count = 0 %}
      {% set negative_count = 0 %}
      {% set neutral_count = 0 %}

      {% for comment in api_comments %}
        {% set text = comment.value | lower %}
        {% set is_positive = false %}
        {% set is_negative = false %}

        {% for word in positive_words %}
          {% if word in text %}
            {% set is_positive = true %}
          {% endif %}
        {% endfor %}

        {% for word in negative_words %}
          {% if word in text %}
            {% set is_negative = true %}
          {% endif %}
        {% endfor %}

        {% if is_positive and not is_negative %}
          {% set positive_count = positive_count + 1 %}
        {% elif is_negative and not is_positive %}
          {% set negative_count = negative_count + 1 %}
        {% else %}
          {% set neutral_count = neutral_count + 1 %}
        {% endif %}
      {% endfor %}

      {
        "total": {{ api_comment_count }},
        "positive": {{ positive_count }},
        "negative": {{ negative_count }},
        "neutral": {{ neutral_count }},
        "positive_percentage": {{ (positive_count / api_comment_count * 100) | round(2) if api_comment_count > 0 else 0 }},
        "negative_percentage": {{ (negative_count / api_comment_count * 100) | round(2) if api_comment_count > 0 else 0 }}
      }

- name: "Exibir análise de sentimento"
  debug:
    msg: |
      Análise de sentimento dos comentários:
      - Total: {{ api_comment_analysis.total }}
      - Positivos: {{ api_comment_analysis.positive }} ({{ api_comment_analysis.positive_percentage }}%)
      - Negativos: {{ api_comment_analysis.negative }} ({{ api_comment_analysis.negative_percentage }}%)
      - Neutros: {{ api_comment_analysis.neutral }}
  when: api_comments | length > 0
  changed_when: false
