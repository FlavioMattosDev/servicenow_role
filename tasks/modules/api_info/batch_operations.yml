# tasks/modules/api_info/batch_operations.yml
---
# Operações em lote (batch)

- name: "Validar parâmetros para operações em lote"
  assert:
    that:
      - api_batch_operations is defined
      - api_batch_operations is iterable
    fail_msg: "api_batch_operations deve ser uma lista de operações"

- name: "Executar Operações em Lote"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"

    # Operações em lote
    batch: "{{ api_batch_operations }}"

    # Controle do batch
    continue_on_error: "{{ api_continue_on_error | default(false) }}"
    interval: "{{ api_batch_interval | default(1) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: api_batch_result
  no_log: true

- name: "Processar resultados do batch"
  set_fact:
    api_batch_success_count: "{{ api_batch_result.results | selectattr('failed', 'equalto', false) | list | length }}"
    api_batch_failed_count: "{{ api_batch_result.results | selectattr('failed', 'equalto', true) | list | length }}"
    api_batch_total_count: "{{ api_batch_result.results | length }}"
    api_batch_success_rate: "{{ (api_batch_success_count / api_batch_total_count * 100) | round(2) if api_batch_total_count > 0 else 0 }}"

- name: "Exibir resumo das operações em lote"
  debug:
    msg: |
      ============================================
      OPERAÇÕES EM LOTE - RESUMO
      ============================================
      Total de operações: {{ api_batch_total_count }}
      Operações bem-sucedidas: {{ api_batch_success_count }}
      Operações com falha: {{ api_batch_failed_count }}
      Taxa de sucesso: {{ api_batch_success_rate }}%

      Tipo de operações:
      {% set op_types = {} %}
      {% for result in api_batch_result.results %}
        {% set op_type = result.item.operation | default('unknown') %}
        {% if op_types[op_type] is defined %}
          {% set _ = op_types.update({op_type: op_types[op_type] + 1}) %}
        {% else %}
          {% set _ = op_types.update({op_type: 1}) %}
        {% endif %}
      {% endfor %}
      {% for op_type, count in op_types.items() %}
      - {{ op_type }}: {{ count }}
      {% endfor %}
      ============================================
  changed_when: false

- name: "Exibir operações com falha"
  debug:
    msg: |
      Operações com falha ({{ api_batch_failed_count }}):
      {% for result in api_batch_result.results %}
        {% if result.failed | default(false) %}
      - Operação {{ loop.index }}: {{ result.item.operation | default('unknown') }}
        Erro: {{ result.msg | default('Sem mensagem de erro') }}
        {% endif %}
      {% endfor %}
  when: api_batch_failed_count > 0
  changed_when: false

- name: "Salvar resultados detalhados do batch"
  copy:
    content: "{{ api_batch_result | to_nice_json }}"
    dest: "{{ api_batch_output_file | default('/tmp/batch_results_' + ansible_date_time.date + '.json') }}"
    mode: 0644
  when: api_save_batch_results | default(false) | bool
  changed_when: false
