# tasks/modules/api_info/get_relationship.yml
---
# Obter relacionamentos de um registro

- name: "Validar parâmetros para obter relacionamentos"
  assert:
    that:
      - api_table is defined
      - api_sys_id is defined
    fail_msg: "api_table e api_sys_id são obrigatórios"

- name: "Obter Relacionamentos do Registro"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"

    # Usar endpoint de relacionamentos
    table: "{{ api_table }}"
    sys_id: "{{ api_sys_id }}"

    # Parâmetros específicos para relacionamentos
    sysparm_include_count: "true"
    sysparm_display_value: "true"

    # Especificar relacionamentos
    sysparm_query: "{{ api_relationship_query | default('') }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: api_relationship_result
  no_log: true

- name: "Obter metadados de relacionamentos da tabela"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "sys_db_object"
    query: "name={{ api_table }}"
    sysparm_fields: "sys_name,label"
    sysparm_limit: 1
  register: api_table_metadata
  no_log: true

- name: "Processar informações de relacionamento"
  set_fact:
    api_relationships: "{{ api_relationship_result | default({}) }}"
    api_table_label: "{{ api_table_metadata.records[0].label if api_table_metadata.records | length > 0 else api_table }}"

- name: "Exibir relacionamentos encontrados"
  debug:
    msg: |
      ============================================
      RELACIONAMENTOS DO REGISTRO
      ============================================
      Tabela: {{ api_table }} ({{ api_table_label }})
      SYS_ID: {{ api_sys_id }}

      Relacionamentos disponíveis:
      {% if api_relationships is mapping %}
        {% for key, value in api_relationships.items() %}
          {% if key != 'record' and key != 'total_count' and key != 'has_more' %}
      - {{ key }}: {{ value | length if value is iterable and value is not string else 'N/A' }}
          {% endif %}
        {% endfor %}
      {% else %}
      Nenhum relacionamento retornado ou formato inválido
      {% endif %}
      ============================================
  changed_when: false

- name: "Exibir detalhes de relacionamentos específicos"
  debug:
    msg: |
      Detalhes dos relacionamentos:
      {% for rel_name in api_specific_relationships | default([]) %}
        {% if api_relationships[rel_name] is defined %}
      {{ rel_name }} ({{ api_relationships[rel_name] | length }}):
          {% for item in api_relationships[rel_name][0:api_display_limit|default(3)] %}
        - {{ item.number | default(item.sys_id) }}: {{ item.short_description | default('Sem descrição') }}
          {% endfor %}
        {% endif %}
      {% endfor %}
  when: api_specific_relationships is defined
  changed_when: false
