# tasks/modules/change/post_implementation_review.yml
---
# Registrar revisão pós-implementação

- name: "Validar parâmetros para revisão pós-implementação"
  assert:
    that:
      - change_sys_id is defined
    fail_msg: "change_sys_id é obrigatório"

- name: "Registrar revisão pós-implementação - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.change_request:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ change_sys_id }}"

    # Mudar estado para revisão
    state: "review"

    # Resultados da implementação
    implementation_results: "{{ change_implementation_results | default('Implementação concluída com sucesso') }}"

    # Revisão pós-implementação
    review_comments: "{{ change_review_comments | default('Revisão pós-implementação realizada via Ansible') }}"
    review_date: "{{ change_review_date | default(ansible_date_time.iso8601) }}"

    # Métricas de sucesso
    on_time: "{{ change_on_time | default(true) }}"
    on_budget: "{{ change_on_budget | default(true) }}"
    success_criteria_met: "{{ change_success_criteria_met | default(true) }}"

    # Comentário da revisão
    work_notes: "{{ change_work_notes | default('Revisão pós-implementação registrada.') }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: change_review_result
  no_log: true

- name: "Verificar métricas de sucesso"
  set_fact:
    change_success_summary: |
      Revisão da Change {{ change_sys_id }}:
      - No prazo: {{ change_on_time | default(true) }}
      - No orçamento: {{ change_on_budget | default(true) }}
      - Critérios atendidos: {{ change_success_criteria_met | default(true) }}
      - Comentários: {{ change_review_comments | default('Revisão pós-implementação realizada via Ansible') }}

- name: "Exibir resultado da revisão"
  debug:
    msg: "{{ change_success_summary }}"
  changed_when: change_review_result is changed
