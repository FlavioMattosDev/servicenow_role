# tasks/modules/change/close_change.yml
---
# Encerrar Change

- name: "Validar parâmetros para encerrar Change"
  assert:
    that:
      - change_sys_id is defined
    fail_msg: "change_sys_id é obrigatório"

- name: "Encerrar Change - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.change_request:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ change_sys_id }}"

    # Encerrar Change
    state: "closed"

    # Notas de fechamento
    close_notes: "{{ change_close_notes | default('Change encerrada via Ansible') }}"
    close_code: "{{ change_close_code | default('successful') }}"

    # Resultado final
    implementation_results: "{{ change_implementation_results | default('Implementação concluída com sucesso') }}"

    # Comentário final
    work_notes: "{{ change_work_notes | default('Change encerrada. Todas as atividades concluídas.') }}"

    # Registrar data de fechamento
    closed_at: "{{ ansible_date_time.iso8601 }}"

    # Atualizar CI se necessário
    cmdb_ci: "{{ change_updated_ci | default(omit) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: change_close_result
  no_log: true

- name: "Verificar Problems relacionados"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "problem"
    query: "change_request={{ change_sys_id }}"
    sysparm_fields: "sys_id,number"
  register: related_problems
  no_log: true

- name: "Atualizar Problems relacionados"
  servicenow.itsm.problem:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ item.sys_id }}"
    work_notes: "Change relacionada {{ change_sys_id }} foi encerrada. Verificar se Problem foi resolvido."
  loop: "{{ related_problems.records }}"
  when: related_problems.records | length > 0
  no_log: true

- name: "Exibir resultado do encerramento"
  debug:
    msg: |
      Change {{ change_sys_id }} encerrada
      Código: {{ change_close_code | default('successful') }}
      Notas: {{ change_close_notes | default('Change encerrada via Ansible') }}
      Problems atualizados: {{ related_problems.records | length }}
      Alterado: {{ change_close_result is changed }}
  changed_when: change_close_result is changed
