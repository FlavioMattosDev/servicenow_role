# tasks/modules/change/plan_dates.yml
---
# Planejar datas de início e fim

- name: "Validar parâmetros para planejar datas"
  assert:
    that:
      - change_sys_id is defined
      - change_start_date is defined
      - change_end_date is defined
    fail_msg: "change_sys_id, change_start_date e change_end_date são obrigatórios"

- name: "Validar datas"
  assert:
    that:
      - change_start_date is match("^\\d{4}-\\d{2}-\\d{2}")
      - change_end_date is match("^\\d{4}-\\d{2}-\\d{2}")
      - change_start_date < change_end_date
    fail_msg: "Datas inválidas. Use formato YYYY-MM-DD e data de início deve ser anterior à data de fim"

- name: "Planejar datas da Change - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.change_request:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ change_sys_id }}"

    # Definir datas de planejamento
    start_date: "{{ change_start_date }}"
    end_date: "{{ change_end_date }}"

    # Janela de manutenção
    maintenance_schedule: "{{ change_maintenance_schedule | default(omit) }}"

    # Mudar estado para agendado
    state: "scheduled"

    # Planos de implementação
    implementation_plan: "{{ change_implementation_plan | default('Plano de implementação definido para o período ' + change_start_date + ' a ' + change_end_date) }}"
    backout_plan: "{{ change_backout_plan | default('Plano de rollback disponível se necessário') }}"

    # Comentário sobre planejamento
    work_notes: "{{ change_work_notes | default('Change agendada para ' + change_start_date + ' até ' + change_end_date) }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: change_plan_result
  no_log: true

- name: "Exibir datas planejadas"
  debug:
    msg: |
      Datas planejadas para Change {{ change_sys_id }}
      Início: {{ change_start_date }}
      Fim: {{ change_end_date }}
      Duração: {{ ((change_end_date | to_datetime('%Y-%m-%d')) - (change_start_date | to_datetime('%Y-%m-%d'))).days + 1 }} dias
      Alterado: {{ change_plan_result is changed }}
  changed_when: change_plan_result is changed
