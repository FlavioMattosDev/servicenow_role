# tasks/modules/change/set_change_type.yml
---
# Definir tipo de mudança

- name: "Validar parâmetros para definir tipo de change"
  assert:
    that:
      - change_sys_id is defined
      - change_type is defined
    fail_msg: "change_sys_id e change_type são obrigatórios"

- name: "Validar tipos de change"
  assert:
    that:
      - change_type in ['normal', 'standard', 'emergency']
    fail_msg: "Tipo de change '{{ change_type }}' inválido. Use: normal, standard, emergency"

- name: "Definir tipo de Change - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.change_request:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ change_sys_id }}"

    # Definir tipo de change
    type: "{{ change_type }}"

    # Ajustar categoria baseada no tipo
    category: "{{ change_category | default('hardware' if change_type == 'normal' else 'standard' if change_type == 'standard' else 'emergency') }}"

    # Ajustar risco baseado no tipo
    risk: "{{ change_risk | default('low' if change_type == 'standard' else 'medium' if change_type == 'normal' else 'high') }}"

    # Comentário explicativo
    work_notes: "{{ change_work_notes | default('Tipo de change definido como ' + change_type) }}"

    # Para changes de emergência, ajustar urgência
    urgency: "{{ change_urgency | default('high' if change_type == 'emergency' else omit) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: change_type_result
  no_log: true

- name: "Exibir tipo de change definido"
  debug:
    msg: |
      Tipo de Change {{ change_sys_id }} definido como {{ change_type }}
      Categoria: {{ change_category | default('hardware' if change_type == 'normal' else 'standard' if change_type == 'standard' else 'emergency') }}
      Risco: {{ change_risk | default('low' if change_type == 'standard' else 'medium' if change_type == 'normal' else 'high') }}
      Alterado: {{ change_type_result is changed }}
  changed_when: change_type_result is changed
