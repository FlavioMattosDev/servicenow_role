# tasks/modules/change/execute_implementation.yml
---
# Executar implementação da Change

- name: "Validar parâmetros para executar implementação"
  assert:
    that:
      - change_sys_id is defined
    fail_msg: "change_sys_id é obrigatório"

- name: "Executar implementação da Change - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.change_request:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ change_sys_id }}"

    # Mudar estado para implementação
    state: "implement"

    # Detalhes da implementação
    implementation_plan: "{{ change_implementation_plan | default('Implementação em andamento via Ansible') }}"

    # Registrar início da implementação
    implemented_at: "{{ ansible_date_time.iso8601 }}"

    # Comentário da implementação
    work_notes: "{{ change_work_notes | default('Implementação iniciada.') }}"

    # Resultados iniciais
    production_system: "{{ change_production_system | default(omit) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: change_implement_result
  no_log: true

- name: "Registrar tarefas de implementação"
  servicenow.itsm.sc_task:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present

    # Criar task relacionada à change
    short_description: "{{ change_task_description | default('Tarefa de implementação para Change ' + change_sys_id) }}"
    description: "{{ change_task_details | default('Execute as etapas de implementação conforme plano.') }}"
    state: "open"
    request_item: "{{ change_task_request_item | default(omit) }}"

    # Relacionar com change
    change_request: "{{ change_sys_id }}"

    # Atribuição
    assignment_group: "{{ change_task_assignment_group | default(omit) }}"
    assigned_to: "{{ change_task_assigned_to | default(omit) }}"

  when: change_create_implementation_task | default(false) | bool
  register: change_implementation_task
  no_log: true

- name: "Exibir implementação em andamento"
  debug:
    msg: |
      Implementação da Change {{ change_sys_id }} em andamento
      Data/Hora de início: {{ ansible_date_time.iso8601 }}
      Task criada: {{ 'Sim' if change_create_implementation_task | default(false) | bool and change_implementation_task is changed else 'Não' }}
      Alterado: {{ change_implement_result is changed }}
  changed_when: change_implement_result is changed
