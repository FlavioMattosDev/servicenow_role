# tasks/modules/change/manage_approvals.yml
---
# Solicitar e gerenciar aprovações

- name: "Validar parâmetros para gerenciar aprovações"
  assert:
    that:
      - change_sys_id is defined
    fail_msg: "change_sys_id é obrigatório"

- name: "Solicitar aprovação da Change - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.change_request:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ change_sys_id }}"

    # Solicitar aprovação
    approval: "{{ change_approval_action | default('requested') }}"

    # Aprovadores
    approval_set: "{{ change_approval_set | default(omit) }}"

    # Justificativa para aprovação
    justification: "{{ change_justification | default(omit) }}"

    # Mudar estado para autorização
    state: "authorize"

    # Comentário sobre aprovação
    work_notes: "{{ change_work_notes | default('Aprovação ' + (change_approval_action | default('requested')) + ' via Ansible') }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: change_approval_result
  no_log: true

- name: "Verificar status de aprovação"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "change_request"
    sys_id: "{{ change_sys_id }}"
    sysparm_fields: "approval,approval_history,approval_set"
  register: change_approval_status
  no_log: true

- name: "Exibir status de aprovação"
  debug:
    msg: |
      Aprovação gerenciada para Change {{ change_sys_id }}
      Ação: {{ change_approval_action | default('requested') }}
      Status: {{ change_approval_status.record.approval if change_approval_status.record.approval is defined else 'N/A' }}
      Conjunto de Aprovação: {{ change_approval_status.record.approval_set.display_value if change_approval_status.record.approval_set is defined else 'N/A' }}
      Alterado: {{ change_approval_result is changed }}
  changed_when: change_approval_result is changed
