# tasks/modules/problem/relate_incidents.yml
---
# Relacionar múltiplos Incidents ao Problem

- name: "Validar parâmetros para relacionar incidents"
  assert:
    that:
      - problem_sys_id is defined
      - incident_sys_ids is defined
    fail_msg: "problem_sys_id e incident_sys_ids são obrigatórios"

- name: "Relacionar Incidents ao Problem - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.incident:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ item }}"
    problem_id: "{{ problem_sys_id }}"
    work_notes: "Incidente relacionado ao Problem {{ problem_sys_id }} via Ansible"
  loop: "{{ incident_sys_ids }}"
  register: problem_relate_incidents_result
  no_log: true

- name: "Verificar Incidents relacionados"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "incident"
    query: "problem_id={{ problem_sys_id }}"
    sysparm_fields: "number,short_description,state"
  register: problem_incidents_list
  no_log: true

- name: "Exibir Incidents relacionados"
  debug:
    msg: |
      Incidents relacionados ao Problem {{ problem_sys_id }}:
      {% for incident in problem_incidents_list.records %}
      - {{ incident.number }}: {{ incident.short_description }} [{{ incident.state }}]
      {% endfor %}
      Total: {{ problem_incidents_list.records | length }} incidents
  changed_when: problem_relate_incidents_result is changed
