# tasks/modules/problem/record_root_cause.yml
---
# Registrar causa raiz do Problem

- name: "Validar parâmetros para registrar causa raiz"
  assert:
    that:
      - problem_sys_id is defined
      - problem_root_cause is defined
    fail_msg: "problem_sys_id e problem_root_cause são obrigatórios"

- name: "Registrar causa raiz do Problem - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.problem:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ problem_sys_id }}"

    # Registrar causa raiz
    root_cause: "{{ problem_root_cause }}"

    # Detalhes da causa raiz
    cause_notes: "{{ problem_cause_notes | default('Causa raiz registrada via Ansible') }}"

    # Mudar estado para análise de causa raiz concluída
    state: "{{ problem_new_state | default('root_cause_analysis') }}"

    # Comentário explicativo
    work_notes: "{{ problem_work_notes | default('Causa raiz identificada e registrada') }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: problem_root_cause_result
  no_log: true

- name: "Exibir causa raiz registrada"
  debug:
    msg: |
      Causa raiz registrada para Problem {{ problem_sys_id }}
      Causa: {{ problem_root_cause }}
      Detalhes: {{ problem_cause_notes | default('Causa raiz registrada via Ansible') }}
      Alterado: {{ problem_root_cause_result is changed }}
  changed_when: problem_root_cause_result is changed
