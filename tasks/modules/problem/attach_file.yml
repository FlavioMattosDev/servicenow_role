# tasks/modules/problem/attach_file.yml
---
# Anexar arquivo ao Problem

- name: "Validar parâmetros para anexar arquivo"
  assert:
    that:
      - problem_sys_id is defined
      - attachment_path is defined
    fail_msg: "problem_sys_id e attachment_path são obrigatórios"

- name: "Verificar se arquivo existe"
  stat:
    path: "{{ attachment_path }}"
  register: attachment_file_stat

- name: "Falhar se arquivo não existir"
  fail:
    msg: "Arquivo não encontrado: {{ attachment_path }}"
  when: not attachment_file_stat.stat.exists

- name: "Anexar arquivo ao Problem - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.attachment:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present

    # Especificar que é para problem
    table_name: "problem"
    table_sys_id: "{{ problem_sys_id }}"
    path: "{{ attachment_path }}"

    # Nome do arquivo
    name: "{{ attachment_name | default(attachment_file_stat.stat.basename) }}"

    # Tipo de conteúdo
    content_type: "{{ attachment_content_type | default(omit) }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: problem_attach_result
  no_log: true

- name: "Exibir resultado do anexo"
  debug:
    msg: |
      Arquivo anexado ao Problem {{ problem_sys_id }}
      Arquivo: {{ attachment_file_stat.stat.basename }}
      Tamanho: {{ attachment_file_stat.stat.size }} bytes
      SYS_ID do anexo: {{ problem_attach_result.attachment.sys_id if problem_attach_result.attachment is defined else 'N/A' }}
  changed_when: problem_attach_result is changed
