# tasks/modules/problem/close_problem.yml
---
# Encerrar Problem

- name: "Validar parâmetros para encerrar Problem"
  assert:
    that:
      - problem_sys_id is defined
    fail_msg: "problem_sys_id é obrigatório"

- name: "Encerrar Problem - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.problem:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ problem_sys_id }}"

    # Encerrar Problem
    state: "closed"

    # Notas de fechamento
    close_notes: "{{ problem_close_notes | default('Problem encerrado via Ansible') }}"
    fix_notes: "{{ problem_fix_notes | default('Problema resolvido conforme documentado') }}"

    # Comentário final
    work_notes: "{{ problem_work_notes | default('Problem encerrado. Solução aplicada e documentada.') }}"

    # Registrar data de fechamento
    closed_at: "{{ ansible_date_time.iso8601 }}"

    # Código de fechamento
    close_code: "{{ problem_close_code | default('Solved (Permanently)') }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: problem_close_result
  no_log: true

- name: "Verificar Incidents relacionados para atualizar"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "incident"
    query: "problem_id={{ problem_sys_id }}^stateNOT IN5,6,7"
    sysparm_fields: "sys_id,number"
  register: related_incidents
  no_log: true

- name: "Atualizar Incidents relacionados"
  servicenow.itsm.incident:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ item.sys_id }}"
    work_notes: "Problem relacionado {{ problem_sys_id }} foi encerrado. Verificar status do incidente."
  loop: "{{ related_incidents.records }}"
  when: related_incidents.records | length > 0
  no_log: true

- name: "Exibir resultado do encerramento"
  debug:
    msg: |
      Problem {{ problem_sys_id }} encerrado
      Notas: {{ problem_close_notes | default('Problem encerrado via Ansible') }}
      Incidents atualizados: {{ related_incidents.records | length }}
      Alterado: {{ problem_close_result is changed }}
  changed_when: problem_close_result is changed
