# tasks/modules/ritm/generate_sc_task.yml
---
# Gerar uma ou mais Catalog Tasks a partir do RITM

- name: "Validar parâmetros para gerar Catalog Tasks"
  assert:
    that:
      - ritm_sys_id is defined
    fail_msg: "ritm_sys_id é obrigatório"

- name: "Obter informações do RITM para geração de tasks"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "sc_req_item"
    sys_id: "{{ ritm_sys_id }}"
    sysparm_fields: "cat_item,short_description,description,request"
  register: ritm_info
  no_log: true

- name: "Criar Catalog Tasks para o RITM - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_task:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present

    # Relacionar com RITM
    request_item: "{{ ritm_sys_id }}"

    # Herdar informações do RITM
    short_description: "{{ sc_task_short_description | default('Task para RITM: ' + ritm_info.record.short_description) }}"
    description: "{{ sc_task_description | default(ritm_info.record.description) }}"

    # Configurar task
    state: "{{ sc_task_state | default('open') }}"
    assignment_group: "{{ sc_task_assignment_group | default(omit) }}"
    assigned_to: "{{ sc_task_assigned_to | default(omit) }}"
    priority: "{{ sc_task_priority | default(3) }}"

    # Campos específicos
    configuration_item: "{{ sc_task_configuration_item | default(omit) }}"
    order: "{{ sc_task_order | default(omit) }}"

    # Gerar múltiplas tasks se especificado
    with_sequence: "count={{ sc_task_count | default(1) }}"
    loop_control:
      loop_var: task_index

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: ritm_generate_tasks_result
  no_log: true

- name: "Exibir Catalog Tasks geradas"
  debug:
    msg: |
      Catalog Tasks geradas para RITM {{ ritm_sys_id }}:
      {% for task in ritm_generate_tasks_result.results %}
      - Task #{{ loop.index }}: {{ task.record.number }} ({{ task.record.sys_id }})
      {% endfor %}
  changed_when: ritm_generate_tasks_result is changed
