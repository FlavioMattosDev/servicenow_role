# tasks/modules/ritm/attach_file.yml
---
# Anexar arquivo ao RITM

- name: "Validar parâmetros para anexar arquivo"
  assert:
    that:
      - ritm_sys_id is defined
      - attachment_path is defined
    fail_msg: "ritm_sys_id e attachment_path são obrigatórios"

- name: "Verificar se arquivo existe"
  stat:
    path: "{{ attachment_path }}"
  register: attachment_file_stat

- name: "Falhar se arquivo não existir"
  fail:
    msg: "Arquivo não encontrado: {{ attachment_path }}"
  when: not attachment_file_stat.stat.exists

- name: "Anexar arquivo ao Requested Item - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.attachment:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present

    # Especificar que é para sc_req_item
    table_name: "sc_req_item"
    table_sys_id: "{{ ritm_sys_id }}"
    path: "{{ attachment_path }}"

    # Nome do arquivo
    name: "{{ attachment_name | default(attachment_file_stat.stat.basename) }}"

    # Tipo de conteúdo
    content_type: "{{ attachment_content_type | default(omit) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: ritm_attach_result
  no_log: true

- name: "Exibir resultado do anexo"
  debug:
    msg: |
      Arquivo anexado ao Requested Item {{ ritm_sys_id }}
      Arquivo: {{ attachment_file_stat.stat.basename }}
      Tamanho: {{ attachment_file_stat.stat.size }} bytes
      SYS_ID do anexo: {{ ritm_attach_result.attachment.sys_id if ritm_attach_result.attachment is defined else 'N/A' }}
  changed_when: ritm_attach_result is changed
