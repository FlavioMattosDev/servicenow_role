# tasks/modules/ritm/relate_to_req.yml
---
# Relacionar RITM com Request (REQ)

- name: "Validar parâmetros para relacionar com Request"
  assert:
    that:
      - ritm_sys_id is defined
      - req_sys_id is defined
    fail_msg: "ritm_sys_id e req_sys_id são obrigatórios"

- name: "Relacionar Requested Item com Request - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_req_item:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ ritm_sys_id }}"

    # Relacionar com Request
    request: "{{ req_sys_id }}"

    # Comentário automático
    work_notes: "{{ ritm_work_notes | default('RITM relacionado ao Request ' + req_sys_id) }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: ritm_relate_req_result
  no_log: true

- name: "Verificar relacionamento"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "sc_req_item"
    sys_id: "{{ ritm_sys_id }}"
    sysparm_fields: "request,request.number"
  register: ritm_info
  no_log: true

- name: "Exibir resultado do relacionamento"
  debug:
    msg: |
      Requested Item {{ ritm_sys_id }} relacionado com Request
      Request SYS_ID: {{ ritm_info.record.request.value if ritm_info.record.request is defined else 'N/A' }}
      Request Número: {{ ritm_info.record.request.display_value if ritm_info.record.request is defined else 'N/A' }}
  changed_when: ritm_relate_req_result is changed
