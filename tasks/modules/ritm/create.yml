# tasks/modules/ritm/create.yml
---
# Criar Requested Item (via Service Catalog)

- name: "Validar parâmetros para criar RITM"
  assert:
    that:
      - ritm_cat_item is defined
    fail_msg: "ritm_cat_item (Item do Catálogo) é obrigatório para criar RITM"

- name: "Criar Requested Item via Service Catalog - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_req_item:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present

    # Item do catálogo obrigatório
    cat_item: "{{ ritm_cat_item }}"

    # Solicitação relacionada
    request: "{{ ritm_request | default(omit) }}"

    # Quantidade
    quantity: "{{ ritm_quantity | default(1) }}"

    # Campos de variáveis do catálogo
    variables: "{{ ritm_variables | default({}) }}"

    # Campos adicionais
    short_description: "{{ ritm_short_description | default('Item solicitado via Ansible') }}"
    description: "{{ ritm_description | default('') }}"
    urgency: "{{ ritm_urgency | default(3) }}"

    # Atribuição
    assignment_group: "{{ ritm_assignment_group | default(omit) }}"
    assigned_to: "{{ ritm_assigned_to | default(omit) }}"

    # Configurações de aprovação
    approval: "{{ ritm_approval | default('not requested') }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: ritm_create_result
  no_log: true

- name: "Registrar SYS_ID do RITM criado"
  set_fact:
    created_ritm_sys_id: "{{ ritm_create_result.record.sys_id }}"
    created_ritm_number: "{{ ritm_create_result.record.number }}"
  when: ritm_create_result is changed

- name: "Exibir resultado da criação"
  debug:
    msg: |
      Requested Item criado com sucesso!
      Número: {{ ritm_create_result.record.number }}
      SYS_ID: {{ ritm_create_result.record.sys_id }}
      Item do Catálogo: {{ ritm_create_result.record.cat_item.display_value if ritm_create_result.record.cat_item is defined else 'N/A' }}
      Estado: {{ ritm_create_result.record.stage if ritm_create_result.record.stage is defined else 'N/A' }}
  when: ritm_create_result is changed
