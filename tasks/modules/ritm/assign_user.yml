# tasks/modules/ritm/assign_user.yml
---
# Atribuir RITM a um usuário

- name: "Validar parâmetros para atribuição a usuário"
  assert:
    that:
      - ritm_sys_id is defined
      - ritm_assigned_to is defined
    fail_msg: "ritm_sys_id e ritm_assigned_to são obrigatórios"

- name: "Atribuir Requested Item para usuário - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_req_item:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ ritm_sys_id }}"

    # Atribuir ao usuário
    assigned_to: "{{ ritm_assigned_to }}"

    # Remover atribuição de grupo se existir
    assignment_group: ""

    # Mudar estágio se especificado
    stage: "{{ ritm_new_stage | default('fulfillment') }}"

    # Comentário automático
    work_notes: "{{ ritm_work_notes | default('RITM atribuído para ' + ritm_assigned_to) }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: ritm_assign_result
  no_log: true

- name: "Exibir resultado da atribuição"
  debug:
    msg: |
      Requested Item {{ ritm_sys_id }} atribuído para {{ ritm_assigned_to }}
      Alterado: {{ ritm_assign_result is changed }}
  changed_when: ritm_assign_result is changed
