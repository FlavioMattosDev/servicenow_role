# tasks/modules/incident/assign_group.yml
---
# Atribuir incidente a um grupo

- name: "Validar parâmetros para atribuição a grupo"
  assert:
    that:
      - incident_sys_id is defined
      - incident_assignment_group is defined
    fail_msg: "incident_sys_id e incident_assignment_group são obrigatórios"

- name: "Atribuir incidente para grupo - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.incident:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ incident_sys_id }}"

    # Atribuir ao grupo
    assignment_group: "{{ incident_assignment_group }}"

    # Remover atribuição individual se existir
    assigned_to: ""

    # Mudar estado se especificado
    state: "{{ incident_new_state | default(2) }}"  # 2 = In Progress

    # Comentário automático
    work_notes: "{{ incident_work_notes | default('Incidente atribuído para o grupo ' + incident_assignment_group) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: incident_assign_group_result
  no_log: true

- name: "Exibir resultado da atribuição para grupo"
  debug:
    msg: |
      Incidente {{ incident_sys_id }} atribuído para grupo {{ incident_assignment_group }}
      Alterado: {{ incident_assign_group_result is changed }}
  changed_when: incident_assign_group_result is changed
