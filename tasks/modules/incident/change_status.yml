# tasks/modules/incident/change_status.yml
---
# Atualizar status do incidente

- name: "Validar parâmetros para mudança de status"
  assert:
    that:
      - incident_sys_id is defined
      - incident_new_state is defined
    fail_msg: "incident_sys_id e incident_new_state são obrigatórios"

- name: "Validar códigos de estado"
  assert:
    that:
      - incident_new_state | int >= 1
      - incident_new_state | int <= 7
    fail_msg: "Estado do incidente deve ser entre 1 (New) e 7 (Approved)"

- name: "Mapear códigos de estado para nomes"
  set_fact:
    state_mapping:
      1: "New"
      2: "In Progress"
      3: "On Hold"
      4: "Resolved"
      5: "Closed"
      6: "Canceled"
      7: "Approved"

- name: "Atualizar status do incidente - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.incident:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ incident_sys_id }}"

    # Mudar estado
    state: "{{ incident_new_state }}"

    # Campos específicos para resolução/fechamento
    close_code: "{{ incident_close_code | default(omit) }}"
    close_notes: "{{ incident_close_notes | default(omit) }}"

    # Comentário automático
    work_notes: "{{ incident_work_notes | default('Status alterado para ' + state_mapping[incident_new_state|int]) }}"

    # Registrar data se estiver resolvendo/fechando
    resolved_at: "{{ ansible_date_time.iso8601 if incident_new_state|int >= 4 else omit }}"
    closed_at: "{{ ansible_date_time.iso8601 if incident_new_state|int == 5 else omit }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: incident_status_result
  no_log: true

- name: "Exibir resultado da mudança de status"
  debug:
    msg: |
      Incidente {{ incident_sys_id }} status alterado para {{ state_mapping[incident_new_state|int] }}
      Alterado: {{ incident_status_result is changed }}
  changed_when: incident_status_result is changed
