# tasks/modules/incident/relate_to_problem.yml
---
# Relacionar incidente com Problem

- name: "Validar parâmetros para relacionar com Problem"
  assert:
    that:
      - incident_sys_id is defined
      - problem_sys_id is defined
    fail_msg: "incident_sys_id e problem_sys_id são obrigatórios"

- name: "Relacionar incidente com Problem - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.incident:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ incident_sys_id }}"

    # Relacionar com Problem
    problem_id: "{{ problem_sys_id }}"

    # Comentário automático
    work_notes: "{{ incident_work_notes | default('Incidente relacionado ao Problem ' + problem_sys_id) }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: incident_relate_problem_result
  no_log: true

- name: "Verificar relacionamento"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    table: "incident"
    sys_id: "{{ incident_sys_id }}"
    sysparm_fields: "problem_id,problem_id.number"
  register: incident_info
  no_log: true

- name: "Exibir resultado do relacionamento"
  debug:
    msg: |
      Incidente {{ incident_sys_id }} relacionado com Problem
      Problem SYS_ID: {{ incident_info.record.problem_id.value if incident_info.record.problem_id is defined else 'N/A' }}
      Problem Número: {{ incident_info.record.problem_id.display_value if incident_info.record.problem_id is defined else 'N/A' }}
  changed_when: incident_relate_problem_result is changed
