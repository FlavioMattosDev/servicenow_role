---
- name: "Incident: Validar identificadores para Atualização"
  ansible.builtin.assert:
    that:
      - (snow_data.number is defined and snow_data.number | length > 0) or
        (snow_data.sys_id is defined and snow_data.sys_id | length > 0)
    fail_msg: >-
      ERRO: Não foi possível identificar o incidente.
      O payload do EDA ou a variável 'snow_data' deve conter 'number' ou 'sys_id'.
      Dados recebidos: {{ snow_data }}

- name: "Incident: Atualizar/Resolver Incidente"
  servicenow.itsm.incident:
    instance: "{{ snow_connection_args.instance }}"

    number: "{{ snow_data.number | default(omit) }}"
    sys_id: "{{ snow_data.sys_id | default(omit) }}"

    state: "{{ snow_data.state | default(omit) }}"

    close_code: "{{ snow_data.close_code | default(omit) }}"
    close_notes: "{{ snow_data.close_notes | default(omit) }}"

    other:
      cause: "{{ snow_data.cause | default(omit) }}"
      resolved_by: "{{ snow_data.resolved_by | default(omit) }}"
      resolved_at: "{{ snow_data.resolved_at | default(omit) }}"
      assignment_group: "{{ snow_data.assignment_group | default(omit) }}"
      work_notes: "{{ snow_data.work_notes | default(omit) }}"
      comments: "{{ snow_data.comments | default(omit) }}"

  register: result_incident_update

- name: "Incident: Debug Atualização"
  ansible.builtin.debug:
    msg: "Incidente {{ result_incident_update.record.number }} atualizado com sucesso. Estado atual: {{ result_incident_update.record.state }}"
  when: result_incident_update.record is defined
