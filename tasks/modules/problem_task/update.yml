---
- name: "PTASK: Validar identificadores para Atualização"
  ansible.builtin.assert:
    that:
      - (snow_data.number is defined and snow_data.number | length > 0) or
        (snow_data.sys_id is defined and snow_data.sys_id | length > 0)
    fail_msg: "ERRO: Informe 'number' (ex: PTASK0010005) ou 'sys_id' da Problem Task."

# Tradução de estado numérico para string.
# Estados padrão do módulo: new, assess, work_in_progress, closed, absent
- name: "PTASK: Resolver estado para envio"
  ansible.builtin.set_fact:
    ptask_state_resolved: >-
      {{
        {
          '1': 'new',
          '2': 'assess',
          '3': 'work_in_progress',
          '4': 'closed'
        }[snow_data.state | string] | default(snow_data.state)
      }}
  when: snow_data.state is defined

- name: "PTASK: Atualizar/Fechar Problem Task"
  servicenow.itsm.problem_task:
    instance: "{{ snow_connection_args.instance }}"

    # Identificação
    number: "{{ snow_data.number | default(omit) }}"
    sys_id: "{{ snow_data.sys_id | default(omit) }}"

    # Estado
    state: "{{ ptask_state_resolved | default(omit) }}"

    # Campos de fechamento (obrigatórios quando state=closed)
    close_code: "{{ snow_data.close_code | default(omit) }}"
    close_notes: "{{ snow_data.close_notes | default(omit) }}"

    # Classificação
    priority: "{{ snow_data.priority | default(omit) }}"

    # Atribuição
    assigned_to: "{{ snow_data.assigned_to | default(omit) }}"
    assignment_group: "{{ snow_data.assignment_group | default(omit) }}"

    # Configuração Item
    cmdb_ci: "{{ snow_data.cmdb_ci | default(omit) }}"

    # Campos adicionais
    other:
      work_notes: "{{ snow_data.work_notes | default(omit) }}"
      comments: "{{ snow_data.comments | default(omit) }}"

  register: result_ptask_update

- name: "PTASK: Debug Atualização"
  ansible.builtin.debug:
    msg: "Problem Task {{ result_ptask_update.record.number }} atualizada. Estado atual: {{ result_ptask_update.record.state }}"
  when: result_ptask_update.record is defined
