# tasks/modules/sc_task/close_technical.yml
---
# Encerrar tarefa técnica

- name: "Validar parâmetros para encerrar tarefa técnica"
  assert:
    that:
      - sc_task_sys_id is defined
    fail_msg: "sc_task_sys_id é obrigatório"

- name: "Encerrar tarefa técnica - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_task:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ sc_task_sys_id }}"

    # Fechar como completo
    state: "closed_complete"

    # Campos obrigatórios para fechamento
    close_code: "{{ sc_task_close_code | default('solved') }}"
    close_notes: "{{ sc_task_close_notes | default('Tarefa técnica encerrada via Ansible') }}"

    # Registrar data de fechamento
    closed_at: "{{ ansible_date_time.iso8601 }}"

    # Adicionar comentário final
    work_notes: "{{ sc_task_work_notes | default('Tarefa técnica encerrada. Resolução aplicada.') }}"

    # Campos técnicos adicionais
    approval: "{{ sc_task_approval | default('approved') }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: sc_task_close_result
  no_log: true

- name: "Exibir resultado do encerramento"
  debug:
    msg: |
      Tarefa técnica {{ sc_task_sys_id }} encerrada
      Código de fechamento: {{ sc_task_close_code | default('solved') }}
      Notas: {{ sc_task_close_notes | default('Tarefa técnica encerrada via Ansible') }}
  changed_when: sc_task_close_result is changed
