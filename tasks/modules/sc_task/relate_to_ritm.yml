# tasks/modules/sc_task/relate_to_ritm.yml
---
# Relacionar Catalog Task com RITM

- name: "Validar parâmetros para relacionar com RITM"
  assert:
    that:
      - sc_task_sys_id is defined
      - ritm_sys_id is defined
    fail_msg: "sc_task_sys_id e ritm_sys_id são obrigatórios"

- name: "Relacionar Catalog Task com RITM - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_task:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ sc_task_sys_id }}"

    # Relacionar com RITM
    request_item: "{{ ritm_sys_id }}"

    # Comentário automático
    work_notes: "{{ sc_task_work_notes | default('Task relacionada ao RITM ' + ritm_sys_id) }}"

    timeout: "{{ servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: sc_task_relate_result
  no_log: true

- name: "Verificar relacionamento"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "sc_task"
    sys_id: "{{ sc_task_sys_id }}"
    sysparm_fields: "request_item,request_item.number"
  register: sc_task_info
  no_log: true

- name: "Exibir resultado do relacionamento"
  debug:
    msg: |
      Catalog Task {{ sc_task_sys_id }} relacionado com RITM
      RITM SYS_ID: {{ sc_task_info.record.request_item.value if sc_task_info.record.request_item is defined else 'N/A' }}
      RITM Número: {{ sc_task_info.record.request_item.display_value if sc_task_info.record.request_item is defined else 'N/A' }}
  changed_when: sc_task_relate_result is changed
