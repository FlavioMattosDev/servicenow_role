---
- name: "SCTASK: Validar Identificador"
  ansible.builtin.assert:
    that:
      - (snow_data.number is defined) or (snow_data.sys_id is defined)
    fail_msg: "ERRO: Informe 'number' ou 'sys_id' da SCTASK."

- name: "SCTASK: Atualizar Tarefa"
  servicenow.itsm.catalog_request_task:
    instance: "{{ snow_connection_args.instance }}"

    # Identificação
    number: "{{ snow_data.number | default(omit) }}"
    sys_id: "{{ snow_data.sys_id | default(omit) }}"

    # State = 'present' garante que o registro existe (não mexe no status)
    state: present

    # --- CORREÇÃO: TRADUTOR DE STATUS ---
    # O módulo exige strings específicas. Aqui convertemos seus números (1,2,3) para elas.
    task_state: >-
      {{
        {
          '1': 'open',
          '2': 'work_in_progress',
          '3': 'closed_complete',
          '4': 'closed_incomplete',
          '7': 'closed_skipped'
        }[snow_data.state | string] | default(snow_data.state) | default(omit)
      }}

    # Campos Principais
    short_description: "{{ snow_data.short_description | default(omit) }}"
    description: "{{ snow_data.description | default(omit) }}"

    # Atribuição
    assignment_group: "{{ snow_data.assignment_group | default(omit) }}"
    assigned_to: "{{ snow_data.assigned_to | default(omit) }}"

    # Campos Adicionais e Customizados
    other:
      work_notes: "{{ snow_data.work_notes | default(omit) }}"
      comments: "{{ snow_data.comments | default(omit) }}"
      u_tcor_substatus: "{{ snow_data.u_tcor_substatus | default(omit) }}"

      # Campos de fechamento (passados em 'other' se o módulo não tiver nativo)
      close_notes: "{{ snow_data.close_notes | default(omit) }}"
      close_code: "{{ snow_data.close_code | default(omit) }}"

  register: result_sctask_update

- name: "SCTASK: Debug Atualização"
  ansible.builtin.debug:
    msg: "Task {{ result_sctask_update.record.number }} atualizada com sucesso."
  when: result_sctask_update.record is defined
