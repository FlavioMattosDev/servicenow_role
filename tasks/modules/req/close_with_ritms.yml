# tasks/modules/req/close_with_ritms.yml
---
# Fechar Request conforme status dos RITMs

- name: "Validar parâmetros para fechar Request"
  assert:
    that:
      - req_sys_id is defined
    fail_msg: "req_sys_id é obrigatório"

- name: "Verificar status dos RITMs associados"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "sc_req_item"
    query: "request={{ req_sys_id }}"
    sysparm_fields: "number,stage,state"
  register: req_ritms_status
  no_log: true

- name: "Determinar se pode fechar Request"
  set_fact:
    can_close_request: "{{ req_ritms_status.records | selectattr('state', 'equalto', 'closed') | list | length == req_ritms_status.records | length }}"
    closed_ritms_count: "{{ req_ritms_status.records | selectattr('state', 'equalto', 'closed') | list | length }}"
    total_ritms_count: "{{ req_ritms_status.records | length }}"

- name: "Fechar Request se todos os RITMs estiverem fechados"
  servicenow.itsm.sc_request:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    state: present
    sys_id: "{{ req_sys_id }}"
    stage: "closed_complete"
    state: "closed"
    close_notes: "Request fechado automaticamente via Ansible. Todos os {{ total_ritms_count }} RITMs estão fechados."
  when: can_close_request | bool
  register: req_close_result
  no_log: true

- name: "Avisar se não pode fechar Request"
  debug:
    msg: |
      Não é possível fechar o Request {{ req_sys_id }}
      RITMs fechados: {{ closed_ritms_count }}/{{ total_ritms_count }}
      Todos os RITMs devem estar fechados antes de fechar o Request.
  when: not (can_close_request | bool)

- name: "Exibir resultado do fechamento"
  debug:
    msg: |
      Request {{ req_sys_id }} fechado com sucesso
      Motivo: Todos os {{ total_ritms_count }} RITMs associados estão fechados
  when: req_close_result is defined and req_close_result is changed
  changed_when: req_close_result is changed
