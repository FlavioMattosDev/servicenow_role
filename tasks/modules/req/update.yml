# tasks/modules/req/update.yml
---
# Atualizar Request

- name: "Validar parâmetros para atualizar Request"
  assert:
    that:
      - req_sys_id is defined
    fail_msg: "req_sys_id é obrigatório para atualizar Request"

- name: "Atualizar Request - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.sc_request:
    instance: "{{ servicenow_creds.servicenow_connection.instance }}"
    username: "{{ servicenow_creds.servicenow_connection.username }}"
    password: "{{ servicenow_creds.servicenow_connection.password }}"
    state: present
    sys_id: "{{ req_sys_id }}"

    # Campos atualizáveis
    short_description: "{{ req_short_description | default(omit) }}"
    description: "{{ req_description | default(omit) }}"
    stage: "{{ req_stage | default(omit) }}"
    state: "{{ req_state | default(omit) }}"

    # Urgência e impacto
    urgency: "{{ req_urgency | default(omit) }}"
    impact: "{{ req_impact | default(omit) }}"

    # Categoria
    category: "{{ req_category | default(omit) }}"
    subcategory: "{{ req_subcategory | default(omit) }}"

    # Solicitação por
    requested_by: "{{ req_requested_by | default(omit) }}"
    requested_for: "{{ req_requested_for | default(omit) }}"

    # Configurações de aprovação
    approval: "{{ req_approval | default(omit) }}"

    timeout: "{{ servicenow_creds.servicenow_connection.timeout | default(servicenow_globals.servicenow_default_timeout) }}"
    validate_certs: "{{ servicenow_creds.servicenow_connection.validate_certs | default(servicenow_globals.servicenow_default_validate_certs) }}"

  register: req_update_result
  no_log: true

- name: "Exibir resultado da atualização"
  debug:
    msg: |
      Request {{ req_sys_id }} atualizado
      Alterado: {{ req_update_result is changed }}
  changed_when: req_update_result is changed
