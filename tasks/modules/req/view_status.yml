# tasks/modules/req/view_status.yml
---
# Visualizar status geral do pedido

- name: "Validar parâmetros para visualizar status"
  assert:
    that:
      - req_sys_id is defined
    fail_msg: "req_sys_id é obrigatório"

- name: "Obter status geral do Request - IMPLEMENTAÇÃO REAL"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "sc_request"
    sys_id: "{{ req_sys_id }}"
    sysparm_display_value: "true"
    sysparm_fields: "number,short_description,stage,state,requested_for,requested_by,opened_at,closed_at,urgency,impact"
  register: req_status
  no_log: true

- name: "Obter RITMs associados ao Request"
  servicenow.itsm.api_info:
    instance: "{{ servicenow_connection.instance }}"
    username: "{{ servicenow_connection.username }}"
    password: "{{ servicenow_connection.password }}"
    table: "sc_req_item"
    query: "request={{ req_sys_id }}"
    sysparm_fields: "number,stage,state,short_description,cat_item"
    sysparm_limit: 20
  register: req_ritms
  no_log: true

- name: "Exibir status geral do pedido"
  debug:
    msg: |
      STATUS GERAL DO REQUEST {{ req_sys_id }}:

      Informações básicas:
      - Número: {{ req_status.record.number }}
      - Descrição: {{ req_status.record.short_description }}
      - Estágio: {{ req_status.record.stage }}
      - Estado: {{ req_status.record.state }}
      - Solicitante: {{ req_status.record.requested_for.display_value }}
      - Aberto por: {{ req_status.record.requested_by.display_value }}
      - Data de abertura: {{ req_status.record.opened_at }}
      - Data de fechamento: {{ req_status.record.closed_at if req_status.record.closed_at is defined else 'Não fechado' }}

      RITMs associados ({{ req_ritms.records | length }}):
      {% for ritm in req_ritms.records %}
      - {{ ritm.number }}: {{ ritm.short_description }} [{{ ritm.stage }}]
      {% endfor %}
  changed_when: false
